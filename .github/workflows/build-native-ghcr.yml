# build-native-ghcr.yml
name: Build and Push Native Image to GHCR
on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }} # ä½¿ç”¨ GitHub ä»“åº“åç§°ä½œä¸ºé•œåƒå
  JAVA_VERSION: '25' # GraalVM JDK ç‰ˆæœ¬

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository # æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: Set up GraalVM # å®‰è£… GraalVMï¼Œæä¾› native-image
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Maven repository # åŠ é€Ÿä¾èµ–ä¸‹è½½
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Extract metadata (tags, labels) for Docker # æå– Docker é•œåƒæ ‡ç­¾
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=

      - name: Build native image with Spring Boot # æ„å»º OCI é•œåƒ (GraalVM native)
        env:
          BP_JVM_VERSION: 25 # Spring Boot 4 éœ€è¦ NIK/GraalVM 25+ï¼Œé¿å… buildpack æŠ¥ç‰ˆæœ¬è¿‡ä½
        run: |
          # ä»å¤šè¡Œæ ‡ç­¾ä¸­æå–ç¬¬ä¸€ä¸ªæ ‡ç­¾ä½œä¸ºé•œåƒæ ‡ç­¾
          TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "Using tag: $TAG"
          ./mvnw -Pnative spring-boot:build-image -DskipTests -Dspring-boot.build-image.imageName=$TAG

      - name: Log in to GitHub Container Registry # ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image to GitHub Container Registry # æ¨é€åˆ° GHCR
        run: |
          # ä»å¤šè¡Œæ ‡ç­¾ä¸­æå–ç¬¬ä¸€ä¸ªæ ‡ç­¾ä½œä¸ºé•œåƒæ ‡ç­¾
          TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          docker push $TAG

      - name: Print deployed container information # æ‰“å°éƒ¨ç½²çš„å®¹å™¨ä¿¡æ¯
        run: |
          # ä»å¤šè¡Œæ ‡ç­¾ä¸­æå–ç¬¬ä¸€ä¸ªæ ‡ç­¾ä½œä¸ºé•œåƒæ ‡ç­¾
          TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "âœ… Docker é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "ğŸ“¦ é•œåƒåç§°: $TAG"
          echo ""
          echo "ğŸš€ æ‹‰å–é•œåƒ: docker pull $TAG"
          echo "ğŸš€ è¿è¡Œé•œåƒ: docker run -p 4567:4567 $TAG"
          echo ""
          echo "ğŸŒ éƒ¨ç½²å®Œæˆï¼Œé•œåƒå·²æ¨é€åˆ° GitHub Container Registry (GHCR)"