name: Build and Push Native Image
on:
  push:
    branches: [ "main-docker" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  IMAGE_REPO: idea-flow/feedback-link-lite # åŸºç¡€é•œåƒè·¯å¾„ï¼ˆå¯èƒ½å«å¤§å†™ï¼Œå…ˆæ ‡å‡†åŒ–ï¼‰
  IMAGE_TAG: latest # ä½¿ç”¨æäº¤å“ˆå¸Œä½œä¸ºä¸å¯å˜æ ‡ç­¾
  JAVA_VERSION: '25' # GraalVM JDK ç‰ˆæœ¬

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository # æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: Set up GraalVM # å®‰è£… GraalVMï¼Œæä¾› native-image
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Maven repository # åŠ é€Ÿä¾èµ–ä¸‹è½½
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Normalize image name to lowercase # Docker è¦æ±‚ä»“åº“/é•œåƒåå°å†™
        run: |
          IMAGE_NAME_NORMALIZED=$(echo "${IMAGE_REPO}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._\/:-]/-/g')
          echo "IMAGE_NAME=${IMAGE_NAME_NORMALIZED}" >> "$GITHUB_ENV"

      - name: Build native image with Spring Boot # æ„å»º OCI é•œåƒ (GraalVM native)
        env:
          BP_JVM_VERSION: 25 # Spring Boot 4 éœ€è¦ NIK/GraalVM 25+ï¼Œé¿å… buildpack æŠ¥ç‰ˆæœ¬è¿‡ä½
        run: ./mvnw -Pnative spring-boot:build-image -DskipTests -Dspring-boot.build-image.imageName=${IMAGE_NAME}:${IMAGE_TAG}

      - name: Tag image as latest # é¢å¤–æ‰“ latest æ ‡ç­¾
        run: docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest

      - name: Log in to Docker Hub # ä½¿ç”¨ä»“åº“å‡­è¯ç™»å½•
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push image to Docker Hub # æ¨é€å”¯ä¸€æ ‡ç­¾ + latest
        run: |
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

      - name: Output image info # æ­¥éª¤6ï¼šè¾“å‡ºé•œåƒä¿¡æ¯ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
        run: |
          echo "âœ… Docker é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "ğŸ“¦ é•œåƒåç§°: ${IMAGE_NAME}"
          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: ${IMAGE_TAG} (å·²åŒæ­¥ latest)"
          echo ""
          echo "ğŸš€ æ‹‰å–é•œåƒ: docker pull ${IMAGE_NAME}:${IMAGE_TAG}"
          echo "ğŸš€ è¿è¡Œé•œåƒ: docker run -p 4567:4567 ${IMAGE_NAME}:${IMAGE_TAG}"
